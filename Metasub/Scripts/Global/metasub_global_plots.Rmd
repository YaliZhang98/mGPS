---
title: "mGPS - MetaSUB global microbiome results and figures"
author: "Yali Zhang, Leo McCarthy and Eran Elhaik"
output: 
  github_document
    
---

```{r setup, echo = F}
### path to mGPS top-level directory here ###
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(fig.width=13, fig.height=8) 
```

This notebook outlines the procedure used to generate MetaSUB global predictions for the mGPS paper, including the code used for figures.  

Load dependencies

```{r, echo=T, eval = T, message = F}
library(sp)
library(rworldmap)
library(caret)
library(maps)
library(geosphere)
library(caret)
library(plyr)
library(rgeos)
library(mapplots)
library(ggrepel)
```

```{r, echo = F}
MetasubDataPreds <- read.csv("Metasub/Outputs/Global/metasub_global_results.csv")
```

# Geographically Informative Taxa


Fig S14, effect of removing redundant taxa.

```{r}
git_subset <- read.csv("Metasub/Outputs/Global/metasub_git_subsets.csv")
plot(git_subset[,"n_vars"], git_subset[,"accuracy"], type = "b", xlab = "", ylab = "", cex = 1.5, col = "dodgerblue")
title(ylab="Accuracy of random forest classifier",xlab = "Number of taxa", mgp=c(2.5,1.5,1),cex.lab=1)
points(git_subset[3,"n_vars"],git_subset[3,"accuracy"], pch = 20, cex = 1.2,col = "dodgerblue")

```

Looking at the results it's clear using all the variables is not optimal. 200 variables is the optimum subset from these results so we will use this as our optimum subset of bacterial species for further analysis when aiming to predict city of origin. 

Fig S15 Top 25 geographic indicator species

```{r}
#Extract and rank species importance
v <- read.csv("Metasub/Outputs/Global/metasub_global_git.csv")
top_species <- v[1:25,"taxa"]

#plot
par(font = 3)
dotchart(rev(v[1:25,"Overall"])*100,labels= rev(top_species),cex=1.2,pt.cex = 1.3,
         xlab="Mean decrease in accuracy", mgp = c(2.2,0,0))

```


Fig S5 Differences in median taxa abundance between cities for the 12 most informative global MetaSUB GITs. 

```{r, messages = F, echo = F}

v <- read.csv("Metasub/Outputs/Global/metasub_global_git.csv")
top_species <- v[1:25,"taxa"]

ag <- aggregate(MetasubDataPreds[, as.character(top_species)], by = list(MetasubDataPreds$city), FUN = median)
city_locations <- aggregate(MetasubDataPreds[,c("city_longitude","city_latitude")], by = list(MetasubDataPreds$city), FUN = mean)
city_abund <- merge(city_locations,ag, by = "Group.1")

for (i in top_species){
  if (max(city_abund[,i]) == 0 ){city_abund[,i] <- 0} 
  else{ city_abund[,i] <- (city_abund[,i]- min(city_abund[,i]) )/(max(city_abund[,i])- min(city_abund[,i]))
  }
}

map <- getMap(resolution = "coarse")
pal <- palette <-c( "gold2","brown","dodgerblue3","darkseagreen2","darkorchid4","darkcyan","orangered2","olivedrab2","deeppink2","darkslateblue","mediumspringgreen")

taxa_name <- colnames(city_abund)[4:15]
taxa_name <- gsub('[.]',' ',taxa_name)
taxa_name <- gsub(' sp ',' sp.',taxa_name)


png('git_map.png', width = 13,height = 8, units = 'in', res = 600)
par(mai=c(2,1,0.5,0.5), mar=par()$mar+c(3,0,0,0))

map <- rworldmap::getMap(resolution = "coarse")

plot(map, xlim = c(-150,168),ylim = c(-50,60), col = "grey",border = "darkgrey", xlab = "", ylab = '', bg = "lightskyblue1")
title(ylab="Latitude",xlab = "Longitude", mgp=c(2,1,0),cex.lab=1.5)
#find coord preds by region
for (i in 1:40){

  col_taxa <- c()
  for(p in 1:12){
    col_p <- seq_gradient_pal(low = "white", high = pal[p])(city_abund[,p+3])[i]
    col_taxa <- c(col_taxa,col_p)
  }
  
  add.pie(z = rep(1/12,12), x = city_abund$city_longitude[i], y = city_abund$city_latitude[i]
          ,edges=200,
          radius=5,
          col=col_taxa, labels = ""
  )
}

legend(-163,-1, taxa_name, pch = 16, col = pal, cex = 1, bg ="lightskyblue1",ncol = 1)

map.axes(cex.axis = 1.3)
box( col = 'black')
par(mar=c(5, 4, 4, 2) + 0.1)
dev.off()

# detail part of England
png('git_map_england.png', width = 13,height = 8, units = 'in', res = 600)
par(mai=c(2,1,0.5,0.5), mar=par()$mar+c(3,0,0,0))

map <- rworldmap::getMap(resolution = "coarse")

plot(map, xlim = c(-5,0),ylim = c(32,65), col = "grey",border = "darkgrey", xlab = "", ylab = '', bg = "lightskyblue1")
title(ylab="Latitude",xlab = "Longitude", mgp=c(2,1,0),cex.lab=1.5)
#find coord preds by region
for (i in 1:40){
  
  col_taxa <- c()
  for(p in 1:12){
    col_p <- seq_gradient_pal(low = "white", high = pal[p])(city_abund[,p+3])[i]
    col_taxa <- c(col_taxa,col_p)
  }
  
  add.pie(z = rep(1/12,12), x = city_abund$city_longitude[i], y = city_abund$city_latitude[i]
          ,edges=200,
          radius=1.6,
          col=col_taxa, labels = ""
  )
}

map.axes(cex.axis = 1.3)
box( col = 'black')
par(mar=c(5, 4, 4, 2) + 0.1)
dev.off()

```

Fig S6 Differences in median taxa abundance between cities for 12 randomly selected taxa from the MetaSUB global analysis.
```{r, messages = F, echo = F}
MetasubDataPreds <- read.csv("Metasub/Outputs/Global/metasub_global_results.csv")
all_species <- colnames(MetasubDataPreds)[46:3714]
set.seed(2206133)
random_species <- sample(all_species,12)

ag <- aggregate(MetasubDataPreds[, as.character(random_species)], by = list(MetasubDataPreds$city), FUN = median)

city_locations <- aggregate(MetasubDataPreds[,c("city_longitude","city_latitude")], by = list(MetasubDataPreds$city), FUN = mean)

for (i in 1:length(city_locations$Group.1)){
  city0 <- city_locations$Group.1[i]
  city_locations[i,'city_longitude'] <- city_abund[city_abund$Group.1==city0,'city_longitude']
  city_locations[i,'city_latitude'] <- city_abund[city_abund$Group.1==city0,'city_latitude']
}

city_abund_random <- merge(city_locations,ag, by = "Group.1")

for (i in random_species){
  if (max(city_abund_random[,i]) == 0 ){city_abund_random[,i] <- 0} 
  else{ city_abund_random[,i] <- (city_abund_random[,i]- min(city_abund_random[,i]) )/(max(city_abund_random[,i])- min(city_abund_random[,i]))
  }
}

map <- getMap(resolution = "coarse")
pal <- palette <-c( "gold2","brown","dodgerblue3","darkseagreen2","darkorchid4","darkcyan","orangered2","olivedrab2","deeppink2","darkslateblue","mediumspringgreen","gray21","royalblue","yellow1","orange","purple1","cyan2","burlywood","aquamarine2","chartreuse4","deeppink4","cadetblue4","goldenrod1","firebrick2","hotpink")

taxa_name <- colnames(city_abund_random)[4:15]
taxa_name <- gsub('[.]',' ',taxa_name)
taxa_name <- gsub(' sp ',' sp.',taxa_name)

png('git_map_random.png', width = 13,height = 8, units = 'in', res = 600)
par(mai=c(2,1,0.5,0.5), mar=par()$mar+c(3,0,0,0))
map <- rworldmap::getMap(resolution = "coarse")

plot(map, xlim = c(-150,168),ylim = c(-50,60), col = "grey",border = "darkgrey", xlab = "", ylab = '', bg = "lightskyblue1")
title(ylab="Latitude",xlab = "Longitude", mgp=c(2,1,0),cex.lab=1.5)
#find coord preds by region
for (i in 1:40){
  col_taxa <- c()
  for(p in 1:12){
    col_p <- seq_gradient_pal(low = "white", high = pal[p])(city_abund_random[,p+3])[i]
    col_taxa <- c(col_taxa,col_p)
  }
  
  add.pie(z = rep(1/12,12), x = city_abund_random$city_longitude[i], y = city_abund_random$city_latitude[i]
          ,edges=200,
          radius=5,
          col=col_taxa, labels = ""
  )
}

legend(-163,-1, taxa_name, pch = 16, col = pal, cex = 1, bg ="lightskyblue1",ncol = 1)

map.axes(cex.axis = 1.3)
box( col = 'black')
par(mar=c(5, 4, 4, 2) + 0.1)
dev.off()

# For England region
png('git_map_random_england.png', width = 13,height = 8, units = 'in', res = 600)

par(mai=c(2,1,0.5,0.5), mar=par()$mar+c(3,0,0,0))
map <- rworldmap::getMap(resolution = "coarse")

plot(map, xlim = c(-5,0),ylim = c(32,65), col = "grey",border = "darkgrey", xlab = "", ylab = '', bg = "lightskyblue1")
title(ylab="Latitude",xlab = "Longitude", mgp=c(2,1,0),cex.lab=1.5)
#find coord preds by region
for (i in 1:40){
  col_taxa <- c()
  for(p in 1:12){
    col_p <- seq_gradient_pal(low = "white", high = pal[p])(city_abund_random[,p+3])[i]
    col_taxa <- c(col_taxa,col_p)
  }
  
  add.pie(z = rep(1/12,12), x = city_abund_random$city_longitude[i], y = city_abund_random$city_latitude[i]
          ,edges=200,
          radius=1.6,
          col=col_taxa, labels = ""
  )
}

map.axes(cex.axis = 1.3)
box( col = 'black')
par(mar=c(5, 4, 4, 2) + 0.1)
dev.off()

```



# Prediction results

Get Prediction results
```{r, warning = F}
na_levels <- setdiff(levels(MetasubDataPreds$city),levels(MetasubDataPreds$cityPred))
levels(MetasubDataPreds$cityPred ) <- c(levels(MetasubDataPreds$cityPred) , na_levels)

res <- confusionMatrix(MetasubDataPreds$cityPred, MetasubDataPreds$city)[[4]]
res <- round(res, 2)

#Print test results 
print(c(mean(MetasubDataPreds$cityPred ==MetasubDataPreds$city)
   ,RMSE(MetasubDataPreds$latPred, MetasubDataPreds$latitude),
       RMSE(MetasubDataPreds$longPred, MetasubDataPreds$longitude)))

```


Find correlation with city population
```{r}
CityPop <- read.csv(file = "Data/Geo/CityPopulations.csv", header = TRUE)

city_names <- c("Auckland" ,"Baltimore" ,"Barcelona", "Berlin","Bogota", 
                "Brisbane","Denver","Doha" ,"Fairbanks","Hamilton",
                "Hanoi","Hong Kong","Ilorin","Kuala Lumpur","Kyiv",
                "Lisbon", "London" ,"Marseille" , "Minneapolis", "Naples"  ,"New York City",
                "Offa" ,"Oslo" ,"Paris","Porto","Rio de Janeiro",
                "Sacramento","San Francisco" ,"Santiago" , "Sao Paulo" ,"Sendai",
                "Seoul","Singapore", "Sofia","Stockholm","Taipei",
                "Tokyo","Vienna","Yamaguchi","Zurich")
city_pop <- data.frame()
for (i in 1:length(levels(MetasubDataPreds$city))){ 
  this_city <- levels(MetasubDataPreds$city)[i]
  city_pop[i,"city_size"] <-  CityPop[i,"population"]
  city_pop[i,"balanced_acc"] <-  res[ paste("Class:", this_city),"Balanced Accuracy"]
  city_pop[i,"within_500"] <-  mean(MetasubDataPreds[MetasubDataPreds$city == this_city, "Distance_from_origin"] < 500)
}
```

Fig S3 correlation with city population

```{r}
options(scipen = 5)
plot(city_pop$city_size,100*city_pop[,"within_500"], xlab ="City population",
     ylab = "Predictions within 500km (%)", pch = 16, cex = 0.7)
text(city_pop$city_size ,100*city_pop[,"within_500"] + 1 ,labels = city_names, cex = 0.6)

```



Next use predicted co-ordinates to a generate the distance of predictions from the true origin using the haversine formula. 


```{r, eval = T, echo = T}
#Using lat long predictions determine distance (km) of the prediction from true origin using haversine distance. 

for (i in 1:nrow(MetasubDataPreds)){
  MetasubDataPreds[i,"Distance_from_origin"] <- geosphere::distm(c(MetasubDataPreds[i,"longPred"],MetasubDataPreds[i,"latPred"]), c(MetasubDataPreds[i,"longitude"],MetasubDataPreds[i,"latitude"]), fun = geosphere::distHaversine)/1000
}



#Print distance from origin results 
print(c(mean(MetasubDataPreds$Distance_from_origin ),
median(MetasubDataPreds$Distance_from_origin ),
mean(MetasubDataPreds$Distance_from_origin < 250)))

```


Fig 2 plot the predicted origin of each global sample. Coloured by continent of origin. City classification prediction accuracy is showm by the pie charts. 

```{r}

#####world map showing by continent
map <- rworldmap::getMap(resolution = "coarse")

palette <-c( "darkorchid4","gold2","dodgerblue3","brown","orangered2","mediumspringgreen","deeppink2")


plot(map, xlim = c(-168,168), col = "grey",border = "darkgrey", xlab = "", ylab = '', bg = "lightskyblue1")
title(ylab="Latitude",xlab = "Longitude", mgp=c(2,1,0),cex.lab=1.5)
#find coord preds by region
for ( i in 1:length(levels(MetasubDataPreds$continent))){
  this_continent <- levels(MetasubDataPreds$continent)[i]
  find_lats <- MetasubDataPreds[MetasubDataPreds[,"continent"] == this_continent,][,"latPred"]
  find_longs <- MetasubDataPreds[MetasubDataPreds[,"continent"] == this_continent,][,"longPred"]
  
  #plot predicted co-ordinates
  points(find_longs, find_lats, col = palette[i], pch = "+", cex = 1.2)
  
  #plot city prediction accuravy by continent as pies
  correctly_pred <-  mean(MetasubDataPreds[MetasubDataPreds$continent == this_continent,"cityPred"]== 
                                 MetasubDataPreds[MetasubDataPreds$continent == this_continent,"city"]) 
  incorrectly_pred <- (1 - correctly_pred) 
  continent_lats <- c(55,69,8,40,-40,-10,-5)
  continent_longs <- c(125,0,60,-130,140,-80,5)
  
  add.pie(z = c(correctly_pred, incorrectly_pred), x = continent_longs[i], y = continent_lats[i]
             ,edges=200,
             radius=10,
             col=c(palette[i],"black") , labels = ""
  )
}

legend(-186,-26, c("East Asia","Eurpoe","Middle East", # -37.5,-36
                   "North America",
                   "Oceania",
                   "South America",
                   "Sub Saharan Afica"), pch = 17, col = palette, cex = 1.3, bg ="lightskyblue1",ncol = 1)

#Plot city sampling locations
map.axes(cex.axis = 1.3)
par(fig = c(0.358,0.817,0,0.56), new = T) 
plot(map,xlim = c(-160,168), col = "grey", border = "darkgrey", bg ="lightskyblue1")
for ( i in 1:length(levels(MetasubDataPreds$continent))){
  this_continent <- levels(MetasubDataPreds$continent)[i]
  find_lats <- MetasubDataPreds[MetasubDataPreds$continent == this_continent,]$city_latitude
  find_longs <- MetasubDataPreds[MetasubDataPreds$continent == this_continent,]$city_longitude
  
  points(find_longs, find_lats, col = palette[i], pch = 17, cex = 1)
}

box( col = 'black')
                    
```

Fig S1-C Europe

```{r}
map <- getMap(resolution = "low")
palette <-c( "gold2","brown","dodgerblue3","darkorchid4","orangered2","olivedrab2","deeppink2","mediumspringgreen", "gray21","royalblue","yellow1","orange","purple1","cyan2")

europe <- droplevels(MetasubDataPreds[MetasubDataPreds$continent == "europe",])

plot(map,xlim = c(-30,50), ylim = c(30,60), col = "grey", border = "grey40", axes =F, bg = "lightskyblue1")
title(ylab="Latitude",xlab = "Longitude", mgp=c(2,1,0),cex.lab=1.4)

for (i in 1:length(levels(europe$city))){
  this_city <- levels(europe$city)[i]
  find_lats <- europe[europe[,"city"] == this_city,]$latPred
  find_longs <- europe[europe[,"city"] == this_city,]$longPred
  
  points(find_longs, find_lats, col = palette[i], pch = "+", cex = 1.5)
  
}

for (i in 1:length(levels(europe$city))){
  this_city <- levels(europe$city)[i]
  
  city_centre.lat <- europe[europe[,"city"] == this_city,]$city_latitude
  city_centre.long <- europe[europe[,"city"] == this_city,]$city_longitude
  
  points(city_centre.long, city_centre.lat, col = "black", bg =palette[i] ,pch = 24, cex = 1.5)
}

legend(-32,60, legend = c("Barcelona","Berlin", "Kyiv", "Lisbon", "London","Marseille",
                          "Naples", "Oslo", "Paris", "Porto", "Sofia", "Stockholm", "Vienna", "Zurich"), col = c(palette),pch = 17, box.lty = 1, cex = 1.1, bg = "lightskyblue1")

map.axes(cex.axis = 1.3)
map.scale(x=-32, cex = 1.1)

```


Fig S1-A North America 

```{r}

palette <-c( "gold2","darkorchid4","dodgerblue3","mediumspringgreen","orangered2","olivedrab2","deeppink2")
north_america <- droplevels(MetasubDataPreds[MetasubDataPreds$continent == "north_america",])

plot(map,xlim = c(-150,0), ylim = c(10,70), col = "grey", border = "grey40", axes =F, bg = "lightskyblue1")
title(ylab="Latitude",xlab = "Longitude", mgp=c(2,1,0),cex.lab=1.4)

for (i in 1:length(levels(north_america$city))){
  this_city <- levels(north_america$city)[i]
  find_lats <- north_america[north_america[,"city"] == this_city,]$latPred
  find_longs <- north_america[north_america[,"city"] == this_city,]$longPred

  points(find_longs, find_lats, col = palette[i], pch = "+", cex = 1.5)
 
}

for (i in 1:length(levels(north_america$city))){
  this_city <- levels(north_america$city)[i]
 
  city_centre.lat <- north_america[north_america[,"city"] == this_city,]$city_latitude
  city_centre.long <- north_america[north_america[,"city"] == this_city,]$city_longitude
  
  points(city_centre.long, city_centre.lat, col = "black", bg =palette[i] ,pch = 24, cex = 1.5)
}

legend(-153,40, legend = c("Baltimore","Denver","Fairbanks",
                          "Minneapolis","New York City", "Sacramento","San Francisco"), col = c(palette),pch = 17, box.lty = 1, cex = 1.2, bg = "lightskyblue1")

map.axes(cex.axis = 1.3)
map.scale(x=-54, cex = 1.1)

```

Fig S1-B South America
```{r}
palette <-c( "gold2","darkorchid4","dodgerblue3","deeppink2")
south_america <- droplevels(MetasubDataPreds[MetasubDataPreds$continent == "south_america",])


plot(map,xlim = c(-90,5), ylim = c(-55,30),col = "grey", border = "grey40", axes =F, bg = "lightskyblue1")
title(ylab="Latitude",xlab = "Longitude", mgp=c(2,1,0),cex.lab=1.4)

for (i in 1:length(levels(south_america$city))){
  this_city <- levels(south_america$city)[i]
  find_lats <- south_america[south_america[,"city"] == this_city,]$latPred
  find_longs <- south_america[south_america[,"city"] == this_city,]$longPred
  
  points(find_longs, find_lats, col = palette[i], pch = "+", cex = 1.5)
  
}
for (i in 1:length(levels(south_america$city))){
  this_city <- levels(south_america$city)[i]
  
  city_centre.lat <- south_america[south_america[,"city"] == this_city,]$city_latitude
  city_centre.long <- south_america[south_america[,"city"] == this_city,]$city_longitude
  
  points(city_centre.long, city_centre.lat, col = "black", bg =palette[i] ,pch = 24, cex = 1.5)
}

legend(-130,10, legend = c("Bogota","Rio de Janeiro","Santiago","Sao Paulo"), col = c(palette),pch = 17, box.lty = 1, cex = 1.2, bg = "lightskyblue1")

map.scale(-20,cex = 1.1)
map.axes(cex.axis = 1.3)


```




Fig S1-E south east asia 

```{r}
east_asia <- droplevels(MetasubDataPreds[MetasubDataPreds$continent == "east_asia",])
palette <-c( "gold2","darkorchid4","dodgerblue3","purple1","orangered2","olivedrab2","deeppink2","mediumspringgreen", "gray21")


plot(map,xlim = c(95,100), ylim = c(-15,50), col = "grey", border = "grey40", axes =F, bg = "lightskyblue1")
title(ylab="Latitude",xlab = "Longitude", mgp=c(2,1,0),cex.lab=1.4)

for (i in 1:length(levels(east_asia$city))){
  this_city <- levels(east_asia$city)[i]
  find_lats <- east_asia[east_asia[,"city"] == this_city,]$latPred
  find_longs <- east_asia[east_asia[,"city"] == this_city,]$longPred
  
  points(find_longs, find_lats, col = palette[i], pch = "+", cex = 1.5)
}
for (i in 1:length(levels(east_asia$city))){
  this_city <- levels(east_asia$city)[i]

  city_centre.lat <- east_asia[east_asia[,"city"] == this_city,]$city_latitude
  city_centre.long <- east_asia[east_asia[,"city"] == this_city,]$city_longitude
  
  points(city_centre.long, city_centre.lat, col = "black", bg =palette[i] ,pch = 24, cex = 1.5)
}

legend(145,50, legend = c("Hanoi","Hong Kong",
                          "Kuala Lumpur","Sendai","Seoul",
                          "Singapore","Taipei","Tokyo",
                          "Yamaguchi"),  col = c(palette),pch = 17, box.lty = 1, cex = 1.2, bg = "lightskyblue1")
map.scale(60,cex = 1.1)
map.axes(cex.axis = 1.3)

```


Fig S1-D Africa and middle east

```{r}
palette <-c( "deeppink2","darkorchid4","gold2")
sub_saharan_africa <- droplevels(MetasubDataPreds[MetasubDataPreds$continent %in%  c('sub_saharan_africa','middle_east'),] )

plot(map,xlim = c(10,45), ylim = c(-35,40), col = "grey", border = "grey40", bg = "lightskyblue1")
title(ylab="Latitude",xlab = "Longitude", mgp=c(2,1,0),cex.lab=1.4)

for (i in 1:length(levels(sub_saharan_africa$city))){
  this_city <- levels(sub_saharan_africa$city)[i]
  find_lats <- sub_saharan_africa[sub_saharan_africa[,"city"] == this_city,]$latPred
  find_longs <- sub_saharan_africa[sub_saharan_africa[,"city"] == this_city,]$longPred
 
  points(find_longs, find_lats, col = palette[i], pch = "+", cex = 1.5)
  
}
for (i in 1:length(levels(sub_saharan_africa$city))){
  this_city <- levels(sub_saharan_africa$city)[i]
  
  city_centre.lat <- sub_saharan_africa[sub_saharan_africa[,"city"] == this_city,]$city_latitude
  city_centre.long <- sub_saharan_africa[sub_saharan_africa[,"city"] == this_city,]$city_longitude
 
  points(city_centre.long, city_centre.lat, col = "black", bg =palette[i] ,pch = 24, cex = 1.5)
}

legend(-46,40, legend = c("Doha","Ilorin", "Offa"), col = c(palette),pch = 17, box.lty = 1, cex = 1.2, bg = "lightskyblue1")

map.scale(60,cex = 1.1)
map.axes(cex.axis = 1.3)

```


Fig S1-F Oceania

```{r}
palette <-c( "deeppink2","darkorchid4","gold2")
oceania <- droplevels(MetasubDataPreds[MetasubDataPreds$continent == "oceania",])

plot(map,xlim = c(80,170), ylim = c(-50,30), col = "grey", border = "grey40", bg = "lightskyblue1")
title(ylab="Latitude",xlab = "Longitude", mgp=c(2,1,0),cex.lab=1.4)

for (i in 1:length(levels(oceania$city))){
  this_city <- levels(oceania $city)[i]
  find_lats <- oceania[oceania [,"city"] == this_city,]$latPred
  find_longs <- oceania[oceania [,"city"] == this_city,]$longPred
  city_centre.lat <- oceania[oceania [,"city"] == this_city,]$city_latitude
  city_centre.long <- oceania[oceania [,"city"] == this_city,]$city_longitude
  points(find_longs, find_lats, col = palette[i], pch = "+", cex = 1.5)
  points(city_centre.long, city_centre.lat, col = "black", bg =palette[i] ,pch = 24, cex = 1.5)
}
legend(178,30, legend = c("Auckland", "Brisbane", "Hamilton"), col = c(palette),pch = 17, box.lty = 1, cex = 1.2, bg = "lightskyblue1")

map.scale(cex = 1.1)
map.axes(cex.axis = 1.3)

```


Calculate distance from sampling site for predicted site

```{r}
city_names <- c("Auckland" ,"Baltimore" ,"Barcelona", "Berlin","Bogota", 
                "Brisbane","Denver","Doha" ,"Fairbanks","Hamilton",
                "Hanoi","Hong Kong","Ilorin","Kuala Lumpur","Kyiv",
                "Lisbon", "London" ,"Marseille" , "Minneapolis", "Naples"  ,"New York City",
                "Offa" ,"Oslo" ,"Paris","Porto","Rio de Janeiro",
                "Sacramento","San Francisco" ,"Santiago" , "Sao Paulo" ,"Sendai",
                "Seoul","Singapore", "Sofia","Stockholm","Taipei",
                "Tokyo","Vienna","Yamaguchi","Zurich")


bar_df1 <- data.frame(row.names = c(city_names, "Overall"))


for (i in 1: length(levels(MetasubDataPreds$city))){
  this_city <- levels(MetasubDataPreds$city)[i]
  prop <- mean(MetasubDataPreds[MetasubDataPreds$city == this_city,][,"Distance_from_origin"] < 100)
  bar_df1[i+1,"0 - 100km"] <- prop
  
  overall_prop <- mean(MetasubDataPreds[,"Distance_from_origin"] < 100)
  bar_df1[ 1,"0 - 100km"] <- overall_prop
}


for (i in 1: length(levels(MetasubDataPreds$city))){
  this_city <- levels(MetasubDataPreds$city)[i]
  prop <- mean(MetasubDataPreds[MetasubDataPreds$city == this_city,][,"Distance_from_origin"] > 100 & MetasubDataPreds[MetasubDataPreds$city == this_city,][,"Distance_from_origin"] < 500)
  bar_df1[i+1,"100 - 500km"] <- prop
  
  overall_prop <-mean(MetasubDataPreds[,"Distance_from_origin"] > 100 & MetasubDataPreds[,"Distance_from_origin"] < 500)
  bar_df1[ 1,"100 - 500km"] <- overall_prop
}

for (i in 1: length(levels(MetasubDataPreds$city))){
  this_city <- levels(MetasubDataPreds$city)[i]
  prop <- mean(MetasubDataPreds[MetasubDataPreds$city == this_city,][,"Distance_from_origin"] > 500 & MetasubDataPreds[MetasubDataPreds$city == this_city,][,"Distance_from_origin"] < 1000)
  bar_df1[i+1,"500 - 1000km"] <- prop
  
  overall_prop <- mean(MetasubDataPreds[,"Distance_from_origin"] > 500 & MetasubDataPreds[,"Distance_from_origin"] < 1000)
  bar_df1[ 1,"500 - 1000km"] <- overall_prop
}

for (i in 1: length(levels(MetasubDataPreds$city))){
  this_city <- levels(MetasubDataPreds$city)[i]
  prop <- mean(MetasubDataPreds[MetasubDataPreds$city == this_city,][,"Distance_from_origin"] > 1000 & MetasubDataPreds[MetasubDataPreds$city == this_city,][,"Distance_from_origin"] < 2000)
  bar_df1[i+1,"1000 - 2000km"] <- prop
  
  overall_prop <- mean(MetasubDataPreds[,"Distance_from_origin"] > 1000 & MetasubDataPreds[,"Distance_from_origin"] < 2000)
  bar_df1[ 1,"1000 - 2000km"] <- overall_prop
}
for (i in 1: length(levels(MetasubDataPreds$city))){
  this_city <- levels(MetasubDataPreds$city)[i]
  prop <- mean(MetasubDataPreds[MetasubDataPreds$city == this_city,][,"Distance_from_origin"] > 2000 & MetasubDataPreds[MetasubDataPreds$city == this_city,][,"Distance_from_origin"] < 3000)
  bar_df1[i+1,"2000 - 3000km"] <- prop
  
  overall_prop <- mean(MetasubDataPreds[,"Distance_from_origin"] > 2000 & MetasubDataPreds[,"Distance_from_origin"] < 3000)
  bar_df1[1,"2000 - 3000km"] <- overall_prop
}
for (i in 1: length(levels(MetasubDataPreds$city))){
  this_city <- levels(MetasubDataPreds$city)[i]
  prop <- mean(MetasubDataPreds[MetasubDataPreds$city == this_city,][,"Distance_from_origin"] > 3000 )
  bar_df1[i+1,"> 3000km"] <- prop
  
  overall_prop <- mean(MetasubDataPreds[,"Distance_from_origin"] > 3000)
  bar_df1[ 1,"> 3000km"] <- overall_prop
}
size <- c()
for (i in 1: length(levels(MetasubDataPreds$city))){
  
  this_city <- levels(MetasubDataPreds$city)[i]
  size[i] <- length(which(MetasubDataPreds$city == this_city))
}
```

Fig S2 dist from origin barplot

```{r}

png('MetaSUB_accuracy_bar.png', width = 13,height = 8, units = 'in', res = 600)
par(xpd = T, mar = par()$mar + c(2,0,0,7), mgp = c(0,0.7,0), las=2)
bp <- barplot(t(bar_df1*100), space = 0,col=c("lightyellow","slategray1","lightblue", "skyblue", "royalblue3", "darkblue"), 
              names.arg=c("Overall",paste0(city_names,"  (",size,")"), axes = FALSE) , 
              las =2, cex.names=.6, ylab = "", axisnames = F, axes = F)
axis(side =2, pos = 0)
mtext(text = c("Overall",paste0(city_names," (",size,")")), side = 1, at = bp, line = 0, padj = 1, cex = 0.9)
title(ylab="Proportion of sample predictions %", mgp=c(0,0,0),cex.lab=1)
legend("topright",inset = c(-0.13,0.4), rev(c(colnames(bar_df1))), 
       fill = rev(c("lightyellow","slategray1","lightblue", "skyblue", "royalblue3", "darkblue")) ,
       bty = 1, cex = 0.9)
par(mar=c(5, 4, 4, 2) + 0.1)
dev.off()

png('MetaSUB_city_sample.png', width = 13,height = 8, units = 'in', res = 600)
par(xpd = T, mar = par()$mar + c(12,0,12,7), mgp = c(0,0.7,0), las=2)
bp <- barplot(size, space = 0,col=c('gray87'), 
              names.arg=c(paste0(city_names,"  (",size,")"), axes = FALSE) , 
              las =2, cex.names=.6, ylab = "", axisnames = F, axes = F)
axis(side =2, pos = 0)
mtext(text = c(paste0(city_names," (",size,")")), side = 1, at = bp, line = 0, padj = 1, cex = 0.9)
title(ylab="Sample size", mgp=c(0,0,0),cex.lab=1)

par(mar=c(5, 4, 4, 2) + 0.1)
dev.off()

```



Fig S4, effect of sample size on city accuracy

```{r}
#calculate
city_sample_sizes <- data.frame()
for (i in 1:length(levels(MetasubDataPreds$city))){ 
  this_city <- levels(MetasubDataPreds$city)[i]
  city_sample_sizes[i,"city_size"] <-  summary(MetasubDataPreds$city)[this_city]
  city_sample_sizes[i,"within_500"] <-  mean(MetasubDataPreds[MetasubDataPreds$city == this_city,]$Distance_from_origin < 500)
}

lowess_line <- lowess(city_sample_sizes$city_size,100*city_sample_sizes[,"within_500"])

# plot
ggplot(city_sample_sizes,aes(x=city_size,y=100*city_sample_sizes[,"within_500"]))+
  geom_point()+
  ylab("Predictions within 500km (%)")+
  xlab("Number of samples from city")+
  geom_line(aes(x=lowess_line$x,y=lowess_line$y),colour = "red")+
  geom_text_repel(city_sample_sizes,mapping = aes(x=city_size,y=100*within_500,label=city_names),size=3.5)+
  theme_bw()+
  # ggpubr::stat_cor(color = 'black')+
  theme(axis.text.x = element_blank())

```



