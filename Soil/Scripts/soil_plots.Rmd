---
title: "mGPS - Soil microbiome results and figures"
author: "Yali Zhang, Leo McCarthy and Eran Elhaik"
output: github_document

---

Dependencies
```{r, echo=T, eval = T,message=FALSE}
library(ggplot2)
library(sp)
library(rworldmap)
library(maps)
library(geosphere)
library(caret)
```



```{r setup, echo = F}
### path to mGPS top-level directory here ###
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(fig.width=13, fig.height=8) 
```
Load and combine, soil microbiome taxa and origin metadata

```{r}
SoilDataPreds <- read.csv('Soil/Outputs/soil_results.csv')
```


## GIT plots
Plot Fig S12, top 25 geographic indicator species for soil data

```{r}
#Extract and rank species importance
v <- read.csv(file = "Soil/Outputs/soil_git.csv")
top_species <- v[1:25,"taxa"]


par(font = 3)
dotchart(rev(v[1:25,"Overall"])*100,labels= rev(top_species),cex=1.2,pt.cex = 1.3,
         xlab="Mean decrease in accuracy", mgp = c(2.2,0,0))

```


## Map plots
Fig 5, global soil microbiome predictions. 

```{r}
palette <-c( "deeppink2","darkorchid4","orangered2","gold2","brown","mediumspringgreen")

par(mai=c(2,1,0.5,0.5), mar=par()$mar+c(3,0,0,0))
map <- getMap(resolution = "coarse")

plot(map,xlim = c(-160,160), col = "grey", border = "darkgrey", bg = "lightskyblue1", xlab = "", ylab = "")
title(ylab="Latitude",xlab = "Longitude", mgp=c(2,1,0),cex.lab=1.2)
for (i in 1:length(levels(SoilDataPreds$continent))){
  this_continent <- levels(SoilDataPreds$continent)[i]
  find_lats <- SoilDataPreds[SoilDataPreds[,"continent"] == this_continent,]$latPred
  find_longs <- SoilDataPreds[SoilDataPreds[,"continent"] == this_continent,]$longPred
  points(find_longs, find_lats, col = palette[i], pch = "+", cex = 1.4)
}

legend(-186,-35,legend=c("Africa", "Asia", "Oceania", "Europe", "North America","South America"),
       col=palette,pch =17 ,cex=1.3, bg = "lightskyblue1")  

#Plot sampling locations
map.axes(cex.axis = 1.3)
par(fig = c(0.358,0.817,0,0.56), new = T) #par(fig = c(0.45,0.9,0.45,0.5), new = T) # 
plot(map,xlim = c(-160,168), ylim = c(-50,76), col = "grey", border = "darkgrey", bg ="lightskyblue1")
for ( i in 1:length(levels(MetasubDataPreds$continent))){
  this_continent <- levels(MetasubDataPreds$continent)[i]
  find_lats <- MetasubDataPreds[MetasubDataPreds[,"continent"] == this_continent,][,"latitude"]
  find_longs <- MetasubDataPreds[MetasubDataPreds[,"continent"] == this_continent,][,"longitude"]
  
  #plot predicted co-ordinates
  points(find_longs, find_lats, col = palette[i], pch =17 , cex = 0.8)
}

box( col = 'black')
par(mar=c(5, 4, 4, 2) + 0.1)

```

Find the distance from country of origin for each sample. Put into data frame for plotting. 
```{r}
SoilDataPreds$GPSassign <- map.where(database = "world", SoilDataPreds$longPred, SoilDataPreds$latPred)
SoilDataPreds[is.na(SoilDataPreds$GPSassign),"GPSassign"] <- "In_sea"

for (i in 1:length((SoilDataPreds$country))){ 
  country_lats <- map(database ="world",regions = SoilDataPreds[i,"country"], plot = FALSE)$y
  country_longs <- map(database ="world",regions = SoilDataPreds[i,"country"], plot = FALSE)$x
  pred_lat <- SoilDataPreds[i,]$latPred
  pred_long  <- SoilDataPreds[i,]$longPred
  distance <- c()
  if(SoilDataPreds[i,]$GPSassign == SoilDataPreds[i,]$country){
    SoilDataPreds[i,"distance_from_country"] <- 0
  } else{
    for (n in 1:length(country_lats)){
      distance[n] <- distHaversine(c(pred_long ,pred_lat ),c(country_longs[n],country_lats[n]))/1000
      
    }
    SoilDataPreds[i,"distance_from_country"] <- min(distance, na.rm = TRUE)
  }
}

c <- confusionMatrix(SoilDataPreds$countryPred
                ,SoilDataPreds$country)

#Print results

print( paste("Prediciton Accuracy = ",mean(SoilDataPreds$countryPred ==SoilDataPreds$country),
       "Mean Sensitivity = ", mean(c[[4]][,"Sensitivity"]),
       "Proportion of samples within 100km of origin = ", mean(SoilDataPreds$distance_from_country < 100)))


bar_df <- data.frame(row.names = c( "Overall",levels(SoilDataPreds$country)))

for (i in 1: length(levels(SoilDataPreds$country))){
  overall_prop <- mean(SoilDataPreds[,"distance_from_country"] < 500)
  bar_df[1,"0 - 500km"] <- overall_prop
  
  this_country <- levels(SoilDataPreds$country)[i]
  prop <- mean(SoilDataPreds[SoilDataPreds$country == this_country,][,"distance_from_country"] < 500)
  bar_df[i+1,"0 - 500km"] <- prop
}

for (i in 1: length(levels(SoilDataPreds$country))){
  this_country <- levels(SoilDataPreds$country)[i]
  prop <- mean(SoilDataPreds[SoilDataPreds$country == this_country,][,"distance_from_country"] > 500 & SoilDataPreds[SoilDataPreds$country == this_country,][,"distance_from_country"] < 1000)
  bar_df[i+1,"500 - 1000km"] <- prop
  
  overall_prop <- mean(SoilDataPreds[,"distance_from_country"] > 500 & SoilDataPreds[,"distance_from_country"] < 1000)
  bar_df[ 1,"500 - 1000km"] <- overall_prop
}

for (i in 1: length(levels(SoilDataPreds$country))){
  this_country<- levels(SoilDataPreds$country)[i]
  prop <- mean(SoilDataPreds[SoilDataPreds$country == this_country,][,"distance_from_country"] > 1000 & SoilDataPreds[SoilDataPreds$country == this_country,][,"distance_from_country"] < 2000)
  bar_df[i+1,"1000 - 2000km"] <- prop
  
  overall_prop <- mean(SoilDataPreds[,"distance_from_country"] > 1000 & SoilDataPreds[,"distance_from_country"] < 2000)
  bar_df[ 1,"1000 - 2000km"] <- overall_prop
}
for (i in 1: length(levels(SoilDataPreds$country))){
  this_country <- levels(SoilDataPreds$country)[i]
  prop <- mean(SoilDataPreds[SoilDataPreds$country == this_country,][,"distance_from_country"] > 2000 & SoilDataPreds[SoilDataPreds$country == this_country,][,"distance_from_country"] < 3000)
  bar_df[i+1,"2000 - 3000km"] <- prop
  
  overall_prop <- mean(SoilDataPreds[,"distance_from_country"] > 2000 & SoilDataPreds[,"distance_from_country"] < 3000)
  bar_df[ 1,"2000 - 3000km"] <- overall_prop
}
for (i in 1: length(levels(SoilDataPreds$country))){
  this_country <- levels(SoilDataPreds$country)[i]
  prop <- mean(SoilDataPreds[SoilDataPreds$country == this_country,][,"distance_from_country"] > 3000 )
  bar_df[i+1,"> 3000km"] <- prop
  
  overall_prop <- mean(SoilDataPreds[,"distance_from_country"] > 3000)
  bar_df[ 1,"> 3000km"] <- overall_prop
}

bar_df2 <- bar_df[-1,]
bar_df2 <- bar_df2[(order(bar_df2$`0 - 500km`,decreasing = T)),]
bar_df1 <- rbind(bar_df[1,],bar_df2)

soil_name <- rownames(bar_df1)
soil_name[8] <- "UK Great Britain"
soil_name[14] <- "South Africa"

size1 <- c()
for (i in 2: length(rownames(bar_df1))){
  this_country <- rownames(bar_df1)[i]
  size1 <- c(size1,length(which(SoilDataPreds$country == this_country)))
}


```


Plot Fig S13, distance from country of origin barplot

```{r}

png('soil_accuracy_bar.png', width = 13,height = 8, units = 'in', res = 600)

par(xpd = T, mar = par()$mar + c(5,0,0,7), mgp = c(0,0.7,0), las=2)
bp <- barplot(t(bar_df1*100), col=c("slategray1","lightblue", "skyblue", "royalblue3", "darkblue"), 
              names.arg=c("Overall",paste0(levels(SoilDataPreds$country),"  (",size1,")")) ,
              args.legend = list(x = "topright", inset=c(-0.5,0)), las =2, 
              cex.names=.6,ylab = "", axisnames = F,axes = F, space =0)
axis(side =2, pos = 0)
mtext(text = c("Overall",paste0(soil_name[2:length(soil_name)],"  (",size1,")")) , side = 1, at = bp, line = 0, padj = 1, cex = 1.1)
title(ylab="Proportion of sample predictions %", mgp=c(0,0,0),cex.lab=1.1)
legend("topright",inset = c(-0.16,0.4), rev(c(colnames(bar_df1))), fill = rev(c("slategray1","lightblue", "skyblue", "royalblue3", "darkblue")) , bty = 1, cex = 1.1)
dev.off()


png('soil_country_sample.png', width = 13,height = 8, units = 'in', res = 600)
par(xpd = T, mar = par()$mar + c(12,0,12,7), mgp = c(0,0.7,0), las=2)
bp <- barplot(size1, space = 0,col=c('gray87'), 
              names.arg=c(paste0(city_names,"  (",size,")"), axes = FALSE) , 
              las =2, cex.names=.6, ylab = "", axisnames = F, axes = F)
axis(side =2, pos = 0)
title(ylab="Sample size", mgp=c(0,0,0),cex.lab=1,1)
par(mar=c(5, 4, 4, 2) + 0.1)
dev.off()
```

Fig S11 Differences in median taxa abundance between countries for the 12 most informative soil microbiome GITs.  

```{r, echo = FALSE, messages = F}
ag <- aggregate(SoilDataPreds[,as.character(top_species)], by = list(SoilDataPreds$country), FUN = median)
country_locations <- aggregate(SoilDataPreds[,c("longitude","latitude")], by = list(SoilDataPreds$country), FUN = mean)
country_abund <- merge(country_locations,ag, by = "Group.1")
for (i in top_species){
  if (max(country_abund[,i]) == 0 ){country_abund[,i] <- 0} 
  else{ country_abund[,i] <- (country_abund[,i]- min(country_abund[,i]) )/(max(country_abund[,i])- min(country_abund[,i]))
  }
}

country_abund <- read.csv('country_abund_soil.csv',header = T)
country_abund <- country_abund[,-1]

pal <- palette <-c("gold2","brown","dodgerblue3","darkseagreen2","darkorchid4","darkcyan","orangered2","olivedrab2","deeppink2","darkslateblue","mediumspringgreen","gray21")

png('git_map_soil.png', width = 13,height = 8, units = 'in', res = 600)
par(mai=c(2,1,0.5,0.5), mar=par()$mar+c(3,0,0,0))
map <- rworldmap::getMap(resolution = "coarse")

plot(map, xlim = c(-150,168),ylim = c(-50,60), col = "grey",border = "darkgrey", xlab = "", ylab = '', bg = "lightskyblue1")
title(ylab="Latitude",xlab = "Longitude", mgp=c(2,1,0),cex.lab=1.5)
#find coord preds by region
for (i in 1:40){
  col_taxa <- c()
  for(p in 1:12){
    col_p <- seq_gradient_pal(low = "white", high = pal[p])(country_abund[,p+3])[i]
    col_taxa <- c(col_taxa,col_p)
  }
  
  add.pie(z = rep(1/12,12), x = country_abund$longitude[i], y = country_abund$latitude[i]
          ,edges=200,
          radius=5,
          col=col_taxa, labels = ""
  )
}

legend(-163,-1, colnames(country_abund)[4:15], pch = 16, col = pal, cex = 1, bg ="lightskyblue1",ncol = 1)

map.axes(cex.axis = 1.3)
box( col = 'black')
par(mar=c(5, 4, 4, 2) + 0.1)
dev.off()

```


